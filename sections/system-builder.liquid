{%- comment -%}
  System Builder Section
  A multi-step bat system configurator.

  Metaobjects used:
  - sport:      sport (Single line text)
  - shaft_type: shaft_type (Single line text), sport (Metaobject Reference → sport)
  - shaft_size: shaft_size (Single line text), shaft_type (Metaobject Reference → shaft_type), shaft (Product variant)
{%- endcomment -%}


{{ 'system-builder.css' | asset_url | stylesheet_tag }}


{%- liquid
  assign sports = shop.metaobjects.sport.values
  assign shaft_types = shop.metaobjects.shaft_type.values
  assign shaft_sizes = shop.metaobjects.shaft_size.values
-%}


<system-builder class="system-builder section-{{ section.id }}" id="system-builder-{{ section.id }}">
  {%- comment -%} Data payloads for JavaScript {%- endcomment -%}

  {%- assign sport_label_slots = '1,2,3,4,5' | split: ',' -%}
  <script type="application/json" data-sport-labels>
    [
      {%- assign first_label = true -%}
      {%- for slot in sport_label_slots -%}
        {%- assign h_key  = 'sport_' | append: slot | append: '_handle' -%}
        {%- assign h_val  = section.settings[h_key] -%}
        {%- if h_val != blank -%}
          {%- unless first_label -%},{%- endunless -%}
          {
            "sportHandle":    {{ h_val | json }},
            "shaftTypeTitle": {{ section.settings['sport_' | append: slot | append: '_shaft_type_title'] | json }},
            "shaftSizeTitle": {{ section.settings['sport_' | append: slot | append: '_shaft_size_title'] | json }}
          }
          {%- assign first_label = false -%}
        {%- endif -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-sports>
    [
      {%- for sport in sports -%}
        {
          "id": {{ sport.id | json }},
          "handle": {{ sport.system.handle | json }},
          "name": {{ sport.sport | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>


  <script type="application/json" data-shaft-types>
    [
      {%- for shaft_type in shaft_types -%}
        {
          "id": {{ shaft_type.id | json }},
          "handle": {{ shaft_type.system.handle | json }},
          "name": {{ shaft_type.shaft_type | json }},
          "sportHandles": [
            {%- for sport_ref in shaft_type.sport.value -%}
              {{ sport_ref.system.handle | json }}{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>


  <script type="application/json" data-shaft-sizes>
    [
      {%- for shaft_size in shaft_sizes -%}
        {%- liquid
          assign shaft_variant_list = shaft_size.shaft.value
          assign shaft_type_val = shaft_size.shaft_type.value
          assign shaft_type_handle = ''
          if shaft_type_val.system.handle
            assign shaft_type_handle = shaft_type_val.system.handle
          else
            for st in shaft_type_val
              if shaft_type_handle == ''
                assign shaft_type_handle = st.system.handle
              endif
            endfor
          endif
        -%}
        {
          "id": {{ shaft_size.id | json }},
          "handle": {{ shaft_size.system.handle | json }},
          "name": {{ shaft_size.shaft_size | json }},
          "shaftTypeHandle": {{ shaft_type_handle | json }},
          "shafts": [
            {%- for v in shaft_variant_list -%}
              {
                "id": {{ v.id | json }},
                "title": {{ v.title | json }},
                "price": {{ v.price | json }},
                "productTitle": {{ v.product.title | json }},
                "image": {{ v.image.src | default: v.product.featured_image.src | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>


  <div class="system-builder__container container">
    {%- if section.settings.heading != blank -%}
      <h2 class="system-builder__heading h2">{{ section.settings.heading }}</h2>
    {%- endif -%}

    {%- if section.settings.subheading != blank -%}
      <div class="system-builder__subheading rte">{{ section.settings.subheading }}</div>
    {%- endif -%}

    <div class="system-builder__layout">
      {%- comment -%} Left Column: Steps {%- endcomment -%}
      <div class="system-builder__steps">

        {%- comment -%} Step 1: Sport Selection {%- endcomment -%}
        <div class="system-builder__step" data-step="sport">
          <h3 class="system-builder__step-title h4">{{ section.settings.sport_step_title }}</h3>
          <div class="system-builder__field" data-field="sport">
            <div class="system-builder__chips" data-chips="sport">
              {%- for sport in sports -%}
                {%- render 'system-builder-chip-option',
                  value: sport.system.handle,
                  label: sport.sport,
                  field: 'sport'
                -%}
              {%- else -%}
                <p class="system-builder__empty-message">No sports configured. Add entries to the "sport" metaobject.</p>
              {%- endfor -%}
            </div>
          </div>
        </div>


        {%- comment -%} Step 2: Shaft Type Selection (shown after sport selected) {%- endcomment -%}
        <div class="system-builder__step" data-step="shaft-type" hidden>
          <h3 class="system-builder__step-title h4">{{ section.settings.shaft_type_step_title }}</h3>
          <div class="system-builder__field" data-field="shaft-type">
            <div class="system-builder__chips" data-chips="shaft-type">
              {%- comment -%} Populated by JavaScript based on sport selection {%- endcomment -%}
            </div>
          </div>
        </div>


        {%- comment -%} Step 3: Shaft Size + Product Card (shown after shaft type selected) {%- endcomment -%}
        <div class="system-builder__step" data-step="shaft-size" hidden>
          <h3 class="system-builder__step-title h4">{{ section.settings.shaft_size_step_title }}</h3>
          <div class="system-builder__field" data-field="shaft-size">
            <div class="system-builder__chips" data-chips="shaft-size">
              {%- comment -%} Populated by JavaScript based on shaft type selection {%- endcomment -%}
            </div>
          </div>
          <div class="system-builder__product-display" data-product="shaft" hidden>
            {%- comment -%} Shaft product card populated by JavaScript {%- endcomment -%}
          </div>
        </div>


        {%- comment -%} Balls Panel (shown after a shaft size is selected) {%- endcomment -%}
        <div class="system-builder__step system-builder__step--accessories" data-step="balls" hidden>
          <h3 class="system-builder__step-title h4">{{ section.settings.balls_step_title }}</h3>
          {%- if section.settings.balls_products != blank -%}
            <div class="system-builder__product-grid" data-product-group="balls">
              {%- for product in section.settings.balls_products -%}
                {%- render 'system-builder-product-card',
                  product: product,
                  product_type: 'ball',
                  group: 'balls',
                  index: forloop.index0
                -%}
              {%- endfor -%}
            </div>
          {%- else -%}
            <p class="system-builder__empty-message">No ball products configured. Add products to the "Ball Products" setting.</p>
          {%- endif -%}
        </div>


        {%- comment -%} Pineapples Panel (shown after a shaft size is selected) {%- endcomment -%}
        <div class="system-builder__step system-builder__step--accessories" data-step="pineapples" hidden>
          <h3 class="system-builder__step-title h4">{{ section.settings.pineapples_step_title }}</h3>
          {%- if section.settings.pineapples_products != blank -%}
            <div class="system-builder__product-grid" data-product-group="pineapples">
              {%- for product in section.settings.pineapples_products -%}
                {%- render 'system-builder-product-card',
                  product: product,
                  product_type: 'pineapple',
                  group: 'pineapples',
                  index: forloop.index0
                -%}
              {%- endfor -%}
            </div>
          {%- else -%}
            <p class="system-builder__empty-message">No pineapple products configured. Add products to the "Pineapple Products" setting.</p>
          {%- endif -%}
        </div>

      </div>{%- comment -%} End .system-builder__steps {%- endcomment -%}


      {%- comment -%} Right Column: Summary Sidebar {%- endcomment -%}
      <div class="system-builder__sidebar">
        <div class="system-builder__summary" data-summary>
          <h3 class="system-builder__summary-title h4">{{ section.settings.summary_title | default: 'Your Selection' }}</h3>

          <div class="system-builder__summary-items" data-summary-items>
            {%- comment -%} Dynamically populated by JavaScript {%- endcomment -%}
          </div>

          <div class="system-builder__summary-empty" data-summary-empty>
            <h6>Select products to build your system.</h6>
          </div>

          <div class="system-builder__summary-footer" data-summary-footer hidden>
            <div class="system-builder__summary-total">
              <span class="system-builder__summary-total-label">{{ section.settings.total_label | default: 'Total' }}</span>
              <span class="system-builder__summary-total-price" data-total-price></span>
            </div>

            <button type="button" class="system-builder__add-to-cart button button--primary" data-add-to-cart>
              {{ section.settings.add_to_cart_text | default: 'Add All to Cart' }}
            </button>
          </div>
        </div>
      </div>{%- comment -%} End .system-builder__sidebar {%- endcomment -%}

    </div>{%- comment -%} End .system-builder__layout {%- endcomment -%}
  </div>
</system-builder>


<script src="{{ 'system-builder.js' | asset_url }}" defer></script>


{% schema %}
{
  "name": "System Builder",
  "tag": "section",
  "class": "shopify-section--system-builder",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build Your System"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Sport Selection"
    },
    {
      "type": "text",
      "id": "sport_step_title",
      "label": "Step Title",
      "default": "1. Select Your Sport"
    },
    {
      "type": "header",
      "content": "Shaft Type"
    },
    {
      "type": "text",
      "id": "shaft_type_step_title",
      "label": "Step Title",
      "default": "2. Select Shaft Type"
    },
    {
      "type": "header",
      "content": "Shaft Size"
    },
    {
      "type": "text",
      "id": "shaft_size_step_title",
      "label": "Step Title",
      "default": "3. Select Shaft Size"
    },
    {
      "type": "header",
      "content": "Balls"
    },
    {
      "type": "text",
      "id": "balls_step_title",
      "label": "Panel Title",
      "default": "4. Add Balls"
    },
    {
      "type": "product_list",
      "id": "balls_products",
      "label": "Ball Products",
      "info": "Select ball products to display as accessories",
      "limit": 12
    },
    {
      "type": "header",
      "content": "Pineapples"
    },
    {
      "type": "text",
      "id": "pineapples_step_title",
      "label": "Panel Title",
      "default": "5. Add Pineapples"
    },
    {
      "type": "product_list",
      "id": "pineapples_products",
      "label": "Pineapple Products",
      "info": "Select pineapple products to display as accessories",
      "limit": 12
    },
    {
      "type": "header",
      "content": "Summary"
    },
    {
      "type": "text",
      "id": "summary_title",
      "label": "Summary Title",
      "default": "Your Selection"
    },
    {
      "type": "text",
      "id": "total_label",
      "label": "Total Label",
      "default": "Total"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add All to Cart"
    },
    {
      "type": "header",
      "content": "Sport Step Label Overrides"
    },
    {
      "type": "paragraph",
      "content": "Override step titles per sport (e.g. show 'Select Bat Size' for baseball). Enter the sport's metaobject handle and the titles you want. Leave any title blank to use the section defaults above."
    },
    { "type": "text", "id": "sport_1_handle",          "label": "Sport 1 — Handle",          "info": "e.g. baseball" },
    { "type": "text", "id": "sport_1_shaft_type_title", "label": "Sport 1 — Shaft Type Title", "info": "e.g. Select Bat Type" },
    { "type": "text", "id": "sport_1_shaft_size_title", "label": "Sport 1 — Shaft Size Title", "info": "e.g. Select Bat Size" },
    { "type": "text", "id": "sport_2_handle",          "label": "Sport 2 — Handle" },
    { "type": "text", "id": "sport_2_shaft_type_title", "label": "Sport 2 — Shaft Type Title" },
    { "type": "text", "id": "sport_2_shaft_size_title", "label": "Sport 2 — Shaft Size Title" },
    { "type": "text", "id": "sport_3_handle",          "label": "Sport 3 — Handle" },
    { "type": "text", "id": "sport_3_shaft_type_title", "label": "Sport 3 — Shaft Type Title" },
    { "type": "text", "id": "sport_3_shaft_size_title", "label": "Sport 3 — Shaft Size Title" },
    { "type": "text", "id": "sport_4_handle",          "label": "Sport 4 — Handle" },
    { "type": "text", "id": "sport_4_shaft_type_title", "label": "Sport 4 — Shaft Type Title" },
    { "type": "text", "id": "sport_4_shaft_size_title", "label": "Sport 4 — Shaft Size Title" },
    { "type": "text", "id": "sport_5_handle",          "label": "Sport 5 — Handle" },
    { "type": "text", "id": "sport_5_shaft_type_title", "label": "Sport 5 — Shaft Type Title" },
    { "type": "text", "id": "sport_5_shaft_size_title", "label": "Sport 5 — Shaft Size Title" }
  ],
  "presets": [
    {
      "name": "System Builder"
    }
  ]
}
{% endschema %}
